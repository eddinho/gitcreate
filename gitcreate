#!/bin/bash

# Create and push to a new GitHub repository from the command line.
# Grabs sensible defaults from the containing folder and `.gitconfig`.
# Uses GitHub Personal Access Token for authentication.

set -e  # Exit on error

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Function to print colored messages
print_error() {
    echo -e "${RED}Error: $1${NC}" >&2
}

print_success() {
    echo -e "${GREEN}$1${NC}"
}

print_warning() {
    echo -e "${YELLOW}Warning: $1${NC}"
}

# Function to show usage
show_usage() {
    cat << EOF
Usage: gitcreate [OPTIONS]

Create a new GitHub repository from the command line and push local code to it.

Options:
    -h, --help          Show this help message
    -p, --public        Create a public repository (default: private)

Prerequisites:
    - Git must be installed and configured
    - GitHub username: git config --global github.user <username>
    - GitHub token: git config --global github.token <token>
      (Create token at: https://github.com/settings/tokens)
      Required scopes: repo, user

EOF
    exit 0
}

# Parse command line arguments
REPO_PRIVATE=true
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            ;;
        -p|--public)
            REPO_PRIVATE=false
            shift
            ;;
        *)
            print_error "Unknown option: $1"
            show_usage
            ;;
    esac
done

# Check if git is installed
if ! command -v git &> /dev/null; then
    print_error "Git is not installed. Please install Git first."
    exit 1
fi

# Check if curl is installed
if ! command -v curl &> /dev/null; then
    print_error "curl is not installed. Please install curl first."
    exit 1
fi

# Get GitHub username
username=$(git config github.user || true)
if [ -z "$username" ]; then
    print_error "GitHub username not found."
    echo "Please run: git config --global github.user <your-github-username>"
    exit 1
fi

# Get GitHub token
token=$(git config github.token || true)
if [ -z "$token" ]; then
    print_error "GitHub token not found."
    echo "Please run: git config --global github.token <your-personal-access-token>"
    echo "Create a token at: https://github.com/settings/tokens"
    echo "Required scopes: repo, user"
    exit 1
fi

# Get repository name
dir_name=$(basename "$(pwd)")
echo ""
read -p "Repository name [$dir_name]: " reponame
reponame=${reponame:-$dir_name}

# Validate repository name
if [[ ! "$reponame" =~ ^[a-zA-Z0-9._-]+$ ]]; then
    print_error "Invalid repository name. Use only letters, numbers, hyphens, underscores, and periods."
    exit 1
fi

# Get repository description
read -p "Repository description (optional): " description

# Get repository visibility
if [ "$REPO_PRIVATE" = true ]; then
    visibility="private"
else
    visibility="public"
fi

echo ""
echo "================================"
echo "Repository: $reponame"
echo "Description: ${description:-None}"
echo "Visibility: $visibility"
echo "================================"
echo ""

read -p "Create this repository? (y/n): " confirm
if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
    echo "Aborted."
    exit 0
fi

# Create GitHub repository
echo ""
echo "Creating GitHub repository '$reponame'..."
response=$(curl -s -w "\n%{http_code}" -X POST \
    -H "Authorization: token $token" \
    -H "Accept: application/vnd.github.v3+json" \
    https://api.github.com/user/repos \
    -d "{\"name\":\"$reponame\",\"description\":\"$description\",\"private\":$REPO_PRIVATE,\"has_issues\":true,\"has_downloads\":true,\"has_wiki\":false}")

http_code=$(echo "$response" | tail -n1)
response_body=$(echo "$response" | sed '$d')

if [ "$http_code" -eq 201 ]; then
    print_success "âœ“ Repository created successfully"
else
    print_error "Failed to create repository (HTTP $http_code)"
    echo "$response_body" | grep -o '"message":"[^"]*"' | cut -d'"' -f4
    exit 1
fi

# Create README if it doesn't exist
if [ ! -f "README.md" ]; then
    echo "Creating README.md..."
    cat > README.md << EOF
# $reponame

${description:-A new project}

## Getting Started

TODO: Add project description and instructions

EOF
    print_success "âœ“ README.md created"
fi

# Initialize git and push
echo "Initializing Git repository..."

# Check if already a git repo
if [ -d ".git" ]; then
    print_warning "Already a Git repository"
else
    git init
    print_success "âœ“ Git repository initialized"
fi

# Add and commit files
echo "Adding files..."
git add -A

if git diff --cached --quiet; then
    print_warning "No changes to commit"
else
    git commit -m "Initial commit"
    print_success "âœ“ Files committed"
fi

# Check current branch name and rename if needed
current_branch=$(git rev-parse --abbrev-ref HEAD)
if [ "$current_branch" != "main" ]; then
    git branch -M main
    print_success "âœ“ Renamed branch to 'main'"
fi

# Remove existing origin if it exists
if git remote | grep -q "^origin$"; then
    git remote remove origin
fi

# Add new origin
git remote add origin "https://github.com/$username/$reponame.git"
print_success "âœ“ Remote origin added"

# Push to GitHub
echo "Pushing to GitHub..."
if git push -u origin main; then
    print_success "âœ“ Successfully pushed to GitHub"
else
    print_error "Failed to push to GitHub"
    print_warning "You may need to push manually using: git push -u origin main"
    exit 1
fi

echo ""
print_success "ðŸŽ‰ Repository successfully created and pushed!"
echo ""
echo "Repository URL: https://github.com/$username/$reponame"
echo ""

# Ask to open in browser
read -p "Open repository in browser? (y/n): " answer_browser
if [[ "$answer_browser" =~ ^[Yy]$ ]]; then
    repo_url="https://github.com/$username/$reponame"
    
    # Try different methods to open browser based on OS
    if command -v xdg-open &> /dev/null; then
        xdg-open "$repo_url"
    elif command -v open &> /dev/null; then
        open "$repo_url"
    elif command -v start &> /dev/null; then
        start "$repo_url"
    elif command -v python3 &> /dev/null; then
        python3 -m webbrowser "$repo_url"
    elif command -v python &> /dev/null; then
        python -m webbrowser "$repo_url"
    else
        print_warning "Could not detect browser launcher"
        echo "Please open manually: $repo_url"
    fi
fi
